#!/bin/sh

# Copyright Â© 2009-2015 Jakub Wilk <jwilk@jwilk.net>
#
# This package is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 dated June, 1991.

if [ $# -ge 2 ]
then
    printf '%s [revision]\n' "$0" >&2
    exit 1
fi
if ! [ -d .hg ]
then
    printf '%s requires hg checkout\n' "$0" >&2
    exit 1
fi

set -e -u

pwd="$PWD"
revision="${1:-tip}"
name=$(hg cat -r "$revision" doc/changelog | head -n1 | cut -d ' ' -f 1)
date=$(hg log -r "$revision" --template='{date|isodate}' | head -c 10 | tr -d -)
version=$(hg cat -r "$revision" doc/changelog | head -n1 | cut -d ' ' -f2 | tr -d '()')
released=$(hg cat -r "$revision" doc/changelog | head -n1 | grep -v -w UNRELEASED || true)
[ -n "$released" ] || version="${version}rc${date}"
printf 'Revision: %s\nVersion: %s\n' "$revision" "$version" >&2

set -x
sourceroot=$(mktemp -d -t "$name-source-XXXXXX")
export TAR_OPTIONS='--owner root --group root --mode a+rX --format ustar'
export XZ_OPT='-4e'

# Mercurial archive:
hg archive -r "$revision" "$sourceroot/$name-$version"
cd "$sourceroot"/*

# Remove files that only useful in a VCS checkout:
rm .hg*
rm .travis.yml
rm private/build-source-tarball

# Autoconf & company:
private/autogen
rm -r *.cache

# Generate Makefile.common:
sed -n -e '/^AC_INIT(\[\([^]]*\)\], *\[\([^]]*\)\], *\[\([^]]*\)\],.*/ { s//PACKAGE_NAME=\1\nPACKAGE_VERSION=\2\nPACKAGE_BUGREPORT=\3/p; q }' \
    "configure.ac" \
    > "Makefile.common"
grep -E 'MSGFMT|MSGMERGE|XGETTEXT' "Makefile.common.in" \
| sed >> "Makefile.common" \
    -e 's/@MSGFMT@/msgfmt/' \
    -e 's/@MSGMERGE@/msgmerge/' \
    -e 's/@XGETTEXT@/xgettext/'
cat "Makefile.common"

# Build the manual page and translations:
make -C po/ all check
make -C doc/
make -C doc/po/ all check pdf2djvu.pot

# Prepare tests:
make -C tests/ prepare

# Sweep Makefile.common:
rm Makefile.common

# Tarball with raw source:
cd ..
tar -caf "$pwd/$name-$version.tar.xz" */

# Cleanup:
rm -r "$sourceroot"
set +x
cd "$pwd"
ls -d "$name-$version.tar.xz"

# vim:ts=4 sts=4 sw=4 et
